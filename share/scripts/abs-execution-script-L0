#!/bin/bash
# ==============================================================================
# ABS
# (c) 2012, Petr Kulhanek, kulhanek@chemi.muni.cz
# (c) 2008-2009, Petr Kulhanek, kulhanek@chemi.muni.cz
# Charon Extension Layer v0.9
# (c) 2006, Petr Kulhanek, kulhanek@chemi.muni.cz
# Charon Extension Layer v0.8
# (c) 2005, Petr Kulhanek, kulhanek@chemi.muni.cz
# based on LCC module v1 - v5
# (c) 2001-2004, Petr Kulhanek, kulhanek@chemi.muni.cz
# ==============================================================================

# ------------------------------------------------------------------------------
# mark this job as INFINITY job, this is used by module-add-stat
export _INFINITY_JOB_="_INFINITY_JOB_"

# header -----------------------------------------------------------------------

_DATE=`date`

echo
echo "################################################################################"
echo "#                          *** INFINITY JOB ***                                #"
echo "#                                                                              #"
echo "###                    Beggining of script execution                        ####"
echo "#                                                                              #"
echo "# # Date: `printf %-67s \"$_DATE\"`# #"
echo "#                                                                              #"
echo "################################################################################"
echo
echo " Initial job information (recovered from transmitted environment):"
echo "--------------------------------------------------------------------------------"
echo " Job name             : $INF_JOB_NAME"
echo " Job name suffix      : $INF_JOB_NAME_SUFFIX"
echo " Job input path       : $INF_JOB_PATH"
echo " Job input machine    : $INF_JOB_MACHINE"
echo " Job surrogate machine: $INF_SURROGATE_MACHINE"
echo " Job key              : $INF_JOB_KEY"
echo " ABS Root             : $ABS_ROOT"
echo "------------------------------------------------------"
echo " Hostname             : `hostname -f`"
echo " Site support         : $AMS_SITE_SUPPORT"
echo " Site ID              : $INF_SITE_ID"
echo " ABS module version   : $INF_ABS_VERSION"
echo " AMS boot script      : $INF_BOOT_SCRIPT"
echo " User group           : $INF_UGROUP"
echo " Umask                : $INF_UMASK"
echo ""

if [ "$INF_JOB_MACHINE" != "$INF_SURROGATE_MACHINE" ]; then
    echo "INFO: overriding INF_JOB_MACHINE by INF_SURROGATE_MACHINE"
    INF_JOB_MACHINE="$INF_SURROGATE_MACHINE"
fi

echo "#-------------------------------------------------------------------------------"
echo "# L0.0 Booting into the first execution layer ..."
echo "#-------------------------------------------------------------------------------"
# set umask
echo ">>> Setting umask: $INF_UMASK"
umask "0$INF_UMASK"

# run under different group?
if [ "$INF_UGROUP" != "`id -ng`" ]; then
    echo ">>> Entering new user group: $INF_UGROUP"
    echo ""
    sg "$INF_UGROUP" -c "$ABS_ROOT/share/scripts/abs-execution-script-L0.1"
else
    echo ">>> Keeping current user group: `id -ng`"
    $ABS_ROOT/share/scripts/abs-execution-script-L0.1
fi

echo
echo "################################################################################"
echo "#                                                                              #"
echo "# # Date: `printf %-67s \"$_DATE\"`# #"
echo "#                                                                              #"
echo "###                        End of script execution                          ####"
echo "#                                                                              #"
echo "################################################################################"
echo


