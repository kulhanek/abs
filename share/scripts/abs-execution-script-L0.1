#!/bin/bash
# ==============================================================================
# ABS
# (c) 2012, Petr Kulhanek, kulhanek@chemi.muni.cz
# (c) 2008-2009, Petr Kulhanek, kulhanek@chemi.muni.cz
# Charon Extension Layer v0.9
# (c) 2006, Petr Kulhanek, kulhanek@chemi.muni.cz
# Charon Extension Layer v0.8
# (c) 2005, Petr Kulhanek, kulhanek@chemi.muni.cz
# based on LCC module v1 - v5
# (c) 2001-2004, Petr Kulhanek, kulhanek@chemi.muni.cz
# ==============================================================================

echo ""
echo "#-------------------------------------------------------------------------------"
echo "# L0.1 First execution layer ..."
echo "#-------------------------------------------------------------------------------"

# boot AMS ---------------------------------------------------------------------
echo "User identity ..."
echo "UID   : `id`"
echo "Umask : `umask`"
echo

if [ -f "$INF_BOOT_SCRIPT" ]; then
    # boot AMS system
    source $INF_BOOT_SCRIPT
fi

echo "$ site -v activate $INF_SITE_ID"

site -v activate $INF_SITE_ID

if [ $? -ne 0 ]; then
    echo "" >&2
    echo " ERROR: Unable to activate site ($INF_SITE_ID)!" >&2
    echo "        Please send contents of this file to the site support: $AMS_SITE_SUPPORT" >&2
    echo "" >&2
    exit 1
fi

# destroy ams host cache
echo "$ ams-host --nocache"

ams-host --nocache

echo "$ amsmodule --system add abs:$INF_ABS_VERSION"

# here we should use the same version as it was used for job submision
amsmodule --system add abs:$INF_ABS_VERSION

if [ $? -ne 0 ]; then
    echo "" >&2
    echo " ERROR: Unable to add 'abs:$INF_MODULE_VERS' module!" >&2
    echo "        Please send contents of this file to the site support: $AMS_SITE_SUPPORT" >&2

    echo "" >&2
    exit 1
fi

# =============================================================================
# Stage 01 - execute wrapper script +++++++++++++++++++++++++++++++++++++++++++
# =============================================================================

# Restore job environment ...
source $ABS_ROOT/share/scripts/abs-execution-script-L1
if [ $? -ne 0 ]; then exit 1; fi

# Prepare working directory ...
source $ABS_ROOT/share/scripts/abs-execution-script-L2
if [ $? -ne 0 ]; then exit 1; fi

# Copy input job data ...
$ABS_ROOT/share/scripts/abs-execution-script-L3
if [ $? -ne 0 ]; then exit 1; fi

# Start job ...
source $ABS_ROOT/share/scripts/abs-execution-script-L4
if [ $? -ne 0 ]; then exit 1; fi

# Sync data ...
$ABS_ROOT/share/scripts/abs-execution-script-L5
if [ $? -ne 0 ]; then exit 1; fi

# Clean ...
$ABS_ROOT/share/scripts/abs-execution-script-L6
if [ $? -ne 0 ]; then exit 1; fi

# =============================================================================


