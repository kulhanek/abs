#!/usr/bin/env infinity-env
# ==============================================================================
# Infinity
# (c) 2009,2012 Petr Kulhanek, kulhanek@chemi.muni.cz
# ==============================================================================

if [ -z "$INF_ARG_DESTINATION" ] || [ -z "$INF_ARG_JOB" ]; then
    echo "" >&2
    echo " >>> ERROR: The INF_ARG_DESTINATION or INF_ARG_JOB variables are not set!" >&2
    echo "            The job was not resubmited!" >&2
    echo "" >&2
    exit 1
fi

if [ -z "$INF_INPUT_MACHINE" ] || [ -z "$INF_INPUT_DIR" ]; then
    echo "" >&2
    echo " >>> ERROR: The INF_INPUT_MACHINE or INF_INPUT_DIR variables are not set!" >&2
    echo "            The job was not resubmited!" >&2
    echo "" >&2
    exit 1
fi

# determine job suffix
if [ -z "$INF_EXTERNAL_NAME_SUFFIX" ]; then
    export INF_EXTERNAL_NAME_SUFFIX="#002"
else
    NUM=`echo "$INF_EXTERNAL_NAME_SUFFIX" | tr -d "#"`
    NUM=`expr $NUM + 1 2> /dev/null`
    export INF_EXTERNAL_NAME_SUFFIX="#`printf %03d $NUM 2> /dev/null`"
fi

# add fixperms=none if not present
if ! [[ $INF_ARG_RESOURCES == *"fixperms=none"* ]]; then
    INF_ARG_RESOURCES="$INF_ARG_RESOURCES fixperms=none"
fi

# submit new run
ssh -x $INF_SSH_OPTIONS "$INF_INPUT_MACHINE" "
            if [ -f ~/.bash_profile ]; then source ~/.bash_profile; fi; \
            site activate $INF_SITE_ID; \
            amsmodule add abs:$INF_ABS_VERSION &> /dev/null; \
            if [ -n \"$INF_EXPORTED_MODULES\" ]; then amsmodule add $INF_EXPORTED_MODULES &> /dev/null; fi; \
            cd \"$INF_INPUT_DIR\"; \
            export INF_EXTERNAL_START_AFTER=$INF_JOB_ID;
            export INF_EXTERNAL_NAME_SUFFIX=\"$INF_EXTERNAL_NAME_SUFFIX\";
            psubmit -y -i -e -r \"$INF_ARG_DESTINATION\" \"$INF_ARG_JOB\" $INF_ARG_RESOURCES; "

if [ $? -ne 0 ]; then
    echo "" >&2
    echo " >>> ERROR: Unable to submit the next job run to the batch system!" >&2
    echo "            See error messages above." >&2
    echo "" >&2
    exit 1
fi

exit 0

